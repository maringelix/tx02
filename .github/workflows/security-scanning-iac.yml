name: üîí Security Scanning - IaC

on:
  push:
    branches: [main]
    paths:
      - 'terraform/**'
      - '.github/workflows/security-scanning-iac.yml'
  pull_request:
    branches: [main]
    paths:
      - 'terraform/**'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

env:
  TFSEC_VERSION: v1.28.5
  CHECKOV_VERSION: 3.2.1

jobs:
  terraform-security:
    name: üîç Terraform Security Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better secret detection
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
    
    # ============================================================
    # 1. TFSEC - Terraform Static Analysis
    # ============================================================
    - name: üõ°Ô∏è Run tfsec
      uses: aquasecurity/tfsec-action@v1.0.3
      with:
        working_directory: terraform
        soft_fail: false
        format: sarif
        output: results.sarif
        additional_args: >
          --exclude-downloaded-modules
          --minimum-severity MEDIUM
    
    - name: Upload tfsec results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always() && hashFiles('results.sarif') != ''
      continue-on-error: true
      with:
        sarif_file: results.sarif
        category: tfsec
    
    # ============================================================
    # 2. Checkov - Infrastructure as Code Security
    # ============================================================
    - name: üìã Run Checkov
      id: checkov
      uses: bridgecrewio/checkov-action@v12
      with:
        directory: terraform
        framework: terraform
        quiet: false
        soft_fail: true  # Don't fail pipeline, just report
        skip_check: CKV_AZURE_33,CKV_AZURE_35  # Skip storage account HTTPS (free tier limitation)
        output_format: sarif
        output_file_path: checkov-results.sarif
    
    - name: Upload Checkov results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always() && hashFiles('checkov-results.sarif') != ''
      continue-on-error: true
      with:
        sarif_file: checkov-results.sarif
        category: checkov
    
    # ============================================================
    # 3. Gitleaks - Secrets Detection
    # ============================================================
    - name: üîê Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
    
    # ============================================================
    # 4. Generate Security Report
    # ============================================================
    - name: üìä Generate Security Summary
      if: always()
      run: |
        echo "## üîí Security Scanning Results - IaC" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìÖ Scan Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### üõ°Ô∏è Scanners Executed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Scanner | Purpose | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|---------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| **tfsec** | Terraform static analysis | ‚úÖ Completed |" >> $GITHUB_STEP_SUMMARY
        echo "| **Checkov** | IaC security & compliance | ‚úÖ Completed |" >> $GITHUB_STEP_SUMMARY
        echo "| **Gitleaks** | Secret detection | ‚úÖ Completed |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### üìà What Was Scanned" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ All Terraform files in \`terraform/\` directory" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Azure resource configurations (AKS, SQL, VNet, Storage)" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Entire git history for leaked secrets/credentials" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Security misconfigurations and compliance violations" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### üîç Review Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check the following locations for detailed findings:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. **GitHub Security Tab**: \`Security > Code scanning alerts\`" >> $GITHUB_STEP_SUMMARY
        echo "2. **Workflow Logs**: Detailed output from each scanner" >> $GITHUB_STEP_SUMMARY
        echo "3. **SARIF Files**: \`results.sarif\` and \`checkov-results.sarif\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### üìö Documentation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "For remediation guidance, see [SECURITY_SCANNING.md](../../SECURITY_SCANNING.md)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*üîí Automated security scanning helps catch issues early in the development cycle*" >> $GITHUB_STEP_SUMMARY

  notify-security-team:
    name: üì¢ Notify Security Issues
    runs-on: ubuntu-latest
    needs: terraform-security
    if: failure()
    
    steps:
    - name: Send notification
      run: |
        echo "‚ö†Ô∏è Security scan found issues!"
        echo "Check the Security tab for details: ${{ github.server_url }}/${{ github.repository }}/security/code-scanning"
        echo ""
        echo "For Slack integration, add webhook to SLACK_SECURITY_WEBHOOK secret"
