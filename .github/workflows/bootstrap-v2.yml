name: Bootstrap v2 - Direct Azure CLI

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
        default: 'plan'
      confirm:
        description: 'Type "bootstrap" to confirm (only for apply)'
        required: false

env:
  RESOURCE_GROUP: terraform-state-rg
  STORAGE_ACCOUNT: tfstatetx02
  CONTAINER_NAME: tfstate
  LOCATION: eastus

jobs:
  bootstrap:
    name: Setup Terraform State Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate confirmation for apply
        if: github.event.inputs.action == 'apply' && github.event.inputs.confirm != 'bootstrap'
        run: |
          echo "âŒ Confirmation failed. You must type 'bootstrap' to proceed."
          echo "## âŒ Bootstrap Apply Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reason**: Confirmation text was not 'bootstrap'" >> $GITHUB_STEP_SUMMARY
          exit 1
      
      - name: Extract Azure Credentials
        id: azure-creds
        run: |
          echo "CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientId')" >> $GITHUB_OUTPUT
          echo "CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientSecret')" >> $GITHUB_OUTPUT
          echo "TENANT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.tenantId')" >> $GITHUB_OUTPUT
          echo "SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.subscriptionId')" >> $GITHUB_OUTPUT
      
      - name: Azure CLI Login
        run: |
          az login --service-principal \
            -u "${{ steps.azure-creds.outputs.CLIENT_ID }}" \
            -p "${{ steps.azure-creds.outputs.CLIENT_SECRET }}" \
            --tenant "${{ steps.azure-creds.outputs.TENANT_ID }}"
          
          az account set --subscription "${{ steps.azure-creds.outputs.SUBSCRIPTION_ID }}"
          
          echo "âœ… Logged in as Service Principal"
          az account show
      
      - name: Check if Resources Already Exist (Plan Mode)
        if: github.event.inputs.action == 'plan'
        run: |
          echo "## ðŸ” Checking Current State..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check Resource Group
          if az group show --name ${{ env.RESOURCE_GROUP }} &>/dev/null; then
            echo "âš ï¸ **Resource Group** \`${{ env.RESOURCE_GROUP }}\` **already exists**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Resource Group \`${{ env.RESOURCE_GROUP }}\` will be created" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check Storage Account
          if az storage account show --name ${{ env.STORAGE_ACCOUNT }} --resource-group ${{ env.RESOURCE_GROUP }} &>/dev/null; then
            echo "âš ï¸ **Storage Account** \`${{ env.STORAGE_ACCOUNT }}\` **already exists**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Storage Account \`${{ env.STORAGE_ACCOUNT }}\` will be created" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Show Bootstrap Plan (Plan Mode)
        if: github.event.inputs.action == 'plan'
        run: |
          echo "## ðŸ“‹ Bootstrap Plan - Resources to be Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Location | \`${{ env.LOCATION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | \`${{ env.RESOURCE_GROUP }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Storage Account | \`${{ env.STORAGE_ACCOUNT }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Container | \`${{ env.CONTAINER_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš¡ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To apply: Run workflow again with action=**apply** and confirm=**bootstrap**" >> $GITHUB_STEP_SUMMARY
      
      - name: Create Resource Group (Apply Mode)
        if: github.event.inputs.action == 'apply'
        run: |
          echo "ðŸ“¦ Creating Resource Group: ${{ env.RESOURCE_GROUP }}"
          az group create \
            --name ${{ env.RESOURCE_GROUP }} \
            --location ${{ env.LOCATION }} \
            --tags Environment=shared Purpose=terraform-state ManagedBy=GitHub-Actions
          
          echo "âœ… Resource Group created successfully"
      
      - name: Create Storage Account (Apply Mode)
        if: github.event.inputs.action == 'apply'
        run: |
          echo "ðŸ’¾ Creating Storage Account: ${{ env.STORAGE_ACCOUNT }}"
          az storage account create \
            --name ${{ env.STORAGE_ACCOUNT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --location ${{ env.LOCATION }} \
            --sku Standard_LRS \
            --encryption-services blob \
            --https-only true \
            --min-tls-version TLS1_2 \
            --allow-blob-public-access false \
            --tags Environment=shared Purpose=terraform-state ManagedBy=GitHub-Actions
          
          echo "âœ… Storage Account created successfully"
      
      - name: Enable Versioning (Apply Mode)
        if: github.event.inputs.action == 'apply'
        run: |
          echo "ðŸ”„ Enabling versioning on storage account..."
          az storage account blob-service-properties update \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --enable-versioning true
          
          echo "âœ… Versioning enabled"
      
      - name: Create Blob Container (Apply Mode)
        if: github.event.inputs.action == 'apply'
        run: |
          echo "ðŸ“ Creating Blob Container: ${{ env.CONTAINER_NAME }}"
          az storage container create \
            --name ${{ env.CONTAINER_NAME }} \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --auth-mode login
          
          echo "âœ… Blob Container created successfully"
      
      - name: Configure Soft Delete (Apply Mode)
        if: github.event.inputs.action == 'apply'
        run: |
          echo "ðŸ”’ Configuring soft delete..."
          az storage blob service-properties update \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --enable-delete-retention true \
            --delete-retention-days 7
          
          echo "âœ… Soft delete configured"
      
      - name: Grant Service Principal Access (Apply Mode)
        if: github.event.inputs.action == 'apply'
        run: |
          echo "ðŸ” Granting Service Principal access to Storage Account..."
          
          SP_ID="${{ steps.azure-creds.outputs.CLIENT_ID }}"
          STORAGE_ID=$(az storage account show --name ${{ env.STORAGE_ACCOUNT }} --resource-group ${{ env.RESOURCE_GROUP }} --query id -o tsv)
          
          # Storage Blob Data Contributor role
          az role assignment create \
            --assignee $SP_ID \
            --role "Storage Blob Data Contributor" \
            --scope $STORAGE_ID
          
          echo "âœ… Permissions granted successfully"
      
      - name: Summary
        if: github.event.inputs.action == 'apply'
        run: |
          echo "## âœ… Bootstrap Completed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Terraform Backend Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | \`${{ env.RESOURCE_GROUP }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Storage Account | \`${{ env.STORAGE_ACCOUNT }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Container | \`${{ env.CONTAINER_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Location | \`${{ env.LOCATION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Backend storage configured" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… Service Principal has access" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸš€ Ready to run Terraform Apply workflow" >> $GITHUB_STEP_SUMMARY
