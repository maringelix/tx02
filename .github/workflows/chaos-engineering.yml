name: ğŸ”¥ Azure Chaos Engineering

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        type: choice
        options:
          - prd
          - stg
        default: prd
      experiment_type:
        description: 'Type of chaos experiment'
        required: true
        type: choice
        options:
          - pod-chaos
          - network-latency
          - cpu-stress
          - memory-stress
          - node-shutdown
          - all-experiments
        default: pod-chaos
      duration_minutes:
        description: 'Duration of experiment (minutes)'
        required: true
        type: number
        default: 5
      dry_run:
        description: 'Dry run (validate without executing)'
        required: true
        type: boolean
        default: true

permissions:
  contents: read
  id-token: write

env:
  AZURE_RESOURCE_GROUP: tx02-${{ github.event.inputs.environment }}-rg
  AKS_CLUSTER_NAME: tx02-${{ github.event.inputs.environment }}-aks
  LOCATION: eastus
  CHAOS_NAMESPACE: chaos-testing

jobs:
  setup-chaos-mesh:
    name: ğŸ¯ Setup Chaos Mesh
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ¯ Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: ï¿½ Info about Chaos Engineering
        run: |
          echo "======================================"
          echo "ğŸ”¥ Azure Chaos Engineering"
          echo "======================================"
          echo ""
          echo "â„¹ï¸ Este workflow usa Chaos Mesh (open source) ao invÃ©s de Azure Chaos Studio"
          echo "ğŸ’° Vantagem: Completamente gratuito (sem custos adicionais)"
          echo "ğŸš€ Funcionalidade: Mesma capacidade de injetar falhas no Kubernetes"
          echo ""
          echo "ğŸ“¦ Chaos Mesh Features:"
          echo "  âœ… Pod Chaos - Mata pods aleatoriamente"
          echo "  âœ… Network Chaos - Injeta latÃªncia, perda de pacotes"
          echo "  âœ… Stress Chaos - CPU/Memory stress"
          echo "  âœ… IO Chaos - Problemas de disco"
          echo "  âœ… Time Chaos - ManipulaÃ§Ã£o de tempo"
          echo ""
          echo "ğŸ¯ Cluster: ${{ env.AKS_CLUSTER_NAME }}"
          echo "ğŸ“ Resource Group: ${{ env.AZURE_RESOURCE_GROUP }}"
          echo "â±ï¸ Duration: ${{ github.event.inputs.duration_minutes }} minutes"
          echo "ğŸ§ª Dry Run: ${{ github.event.inputs.dry_run }}"
          echo "======================================"

      - name: ğŸ“¦ Install Chaos Mesh
        run: |
          echo "ğŸ“¦ Installing Chaos Mesh on cluster..."
          
          # Add Chaos Mesh Helm repository
          helm repo add chaos-mesh https://charts.chaos-mesh.org
          helm repo update
          
          # Create namespace
          kubectl create namespace ${{ env.CHAOS_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          
          # Check if Chaos Mesh is already installed
          if helm list -n ${{ env.CHAOS_NAMESPACE }} | grep -q "chaos-mesh"; then
            echo "âš ï¸ Chaos Mesh already installed, upgrading..."
            helm upgrade chaos-mesh chaos-mesh/chaos-mesh \
              --namespace ${{ env.CHAOS_NAMESPACE }} \
              --version 2.6.3 \
              --set chaosDaemon.runtime=containerd \
              --set chaosDaemon.socketPath=/run/containerd/containerd.sock \
              --set dashboard.create=true \
              --set dashboard.securityMode=false
          else
            echo "ğŸ“¦ Installing Chaos Mesh..."
            helm install chaos-mesh chaos-mesh/chaos-mesh \
              --namespace ${{ env.CHAOS_NAMESPACE }} \
              --version 2.6.3 \
              --set chaosDaemon.runtime=containerd \
              --set chaosDaemon.socketPath=/run/containerd/containerd.sock \
              --set dashboard.create=true \
              --set dashboard.securityMode=false
          fi
          
          echo "âœ… Chaos Mesh installed"

      - name: â³ Wait for Chaos Mesh to be ready
        run: |
          echo "â³ Waiting for Chaos Mesh to be ready..."
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/component=controller-manager \
            -n ${{ env.CHAOS_NAMESPACE }} \
            --timeout=300s
          
          echo "âœ… Chaos Mesh is ready"

      - name: ğŸ“Š Display Chaos Mesh status
        run: |
          echo "======================================"
          echo "ğŸ”¥ Chaos Mesh Status"
          echo "======================================"
          echo ""
          kubectl get pods -n ${{ env.CHAOS_NAMESPACE }}
          echo ""
          echo "======================================"
          echo "ğŸ“Š Chaos Mesh CRDs installed:"
          echo "======================================"
          kubectl get crds | grep chaos-mesh.org

  run-pod-chaos:
    name: ğŸ² Pod Chaos (Kill Pods)
    runs-on: ubuntu-latest
    needs: setup-chaos-mesh
    if: |
      github.event.inputs.experiment_type == 'pod-chaos' || 
      github.event.inputs.experiment_type == 'all-experiments'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ¯ Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: ğŸ² Run Pod Chaos Experiment
        run: |
          echo "ğŸ² Running Pod Chaos (Kill Random Pod)..."
          
          cat <<EOF | kubectl apply -f -
          apiVersion: chaos-mesh.org/v1alpha1
          kind: PodChaos
          metadata:
            name: pod-kill-experiment
            namespace: ${{ env.CHAOS_NAMESPACE }}
          spec:
            action: pod-kill
            mode: one
            duration: "${{ github.event.inputs.duration_minutes }}m"
            selector:
              namespaces:
                - dx02
              labelSelectors:
                "app": "dx02"
          EOF
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "âœ… [DRY RUN] Pod Chaos configured but not executed"
            kubectl delete podchaos pod-kill-experiment -n ${{ env.CHAOS_NAMESPACE }}
          else
            echo "âš ï¸ Chaos experiment ACTIVE for ${{ github.event.inputs.duration_minutes }} minutes"
            echo "ğŸ”¥ Pods will be killed randomly during the duration"
          fi

      - name: ğŸ“Š Monitor experiment (if not dry run)
        if: github.event.inputs.dry_run == 'false'
        run: |
          echo "ğŸ“Š Monitoring experiment..."
          sleep 30
          
          echo "Pods in namespace dx02:"
          kubectl get pods -n dx02
          
          echo ""
          echo "Active chaos experiments:"
          kubectl get podchaos -n ${{ env.CHAOS_NAMESPACE }}

  run-network-latency:
    name: ğŸŒ Network Latency
    runs-on: ubuntu-latest
    needs: setup-chaos-mesh
    if: |
      github.event.inputs.experiment_type == 'network-latency' || 
      github.event.inputs.experiment_type == 'all-experiments'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ¯ Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: ğŸŒ Run Network Latency Experiment
        run: |
          echo "ğŸŒ Injecting network latency (200ms)..."
          
          cat <<EOF | kubectl apply -f -
          apiVersion: chaos-mesh.org/v1alpha1
          kind: NetworkChaos
          metadata:
            name: network-latency-experiment
            namespace: ${{ env.CHAOS_NAMESPACE }}
          spec:
            action: delay
            mode: one
            duration: "${{ github.event.inputs.duration_minutes }}m"
            selector:
              namespaces:
                - dx02
              labelSelectors:
                "app": "dx02"
            delay:
              latency: "200ms"
              correlation: "0"
              jitter: "50ms"
          EOF
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "âœ… [DRY RUN] Network Latency configured but not executed"
            kubectl delete networkchaos network-latency-experiment -n ${{ env.CHAOS_NAMESPACE }}
          else
            echo "âš ï¸ Network latency injected: 200ms Â± 50ms for ${{ github.event.inputs.duration_minutes }} minutes"
          fi

  run-cpu-stress:
    name: ğŸ”¥ CPU Stress Test
    runs-on: ubuntu-latest
    needs: setup-chaos-mesh
    if: |
      github.event.inputs.experiment_type == 'cpu-stress' || 
      github.event.inputs.experiment_type == 'all-experiments'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ¯ Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: ğŸ”¥ Run CPU Stress Experiment
        run: |
          echo "ğŸ”¥ Applying CPU stress (80%)..."
          
          cat <<EOF | kubectl apply -f -
          apiVersion: chaos-mesh.org/v1alpha1
          kind: StressChaos
          metadata:
            name: cpu-stress-experiment
            namespace: ${{ env.CHAOS_NAMESPACE }}
          spec:
            mode: one
            duration: "${{ github.event.inputs.duration_minutes }}m"
            selector:
              namespaces:
                - dx02
              labelSelectors:
                "app": "dx02"
            stressors:
              cpu:
                workers: 2
                load: 80
          EOF
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "âœ… [DRY RUN] CPU Stress configured but not executed"
            kubectl delete stresschaos cpu-stress-experiment -n ${{ env.CHAOS_NAMESPACE }}
          else
            echo "âš ï¸ CPU stress active: 80% on 2 workers for ${{ github.event.inputs.duration_minutes }} minutes"
          fi

  run-memory-stress:
    name: ğŸ’¾ Memory Stress Test
    runs-on: ubuntu-latest
    needs: setup-chaos-mesh
    if: |
      github.event.inputs.experiment_type == 'memory-stress' || 
      github.event.inputs.experiment_type == 'all-experiments'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ¯ Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: ğŸ’¾ Run Memory Stress Experiment
        run: |
          echo "ğŸ’¾ Applying memory stress (256MB)..."
          
          cat <<EOF | kubectl apply -f -
          apiVersion: chaos-mesh.org/v1alpha1
          kind: StressChaos
          metadata:
            name: memory-stress-experiment
            namespace: ${{ env.CHAOS_NAMESPACE }}
          spec:
            mode: one
            duration: "${{ github.event.inputs.duration_minutes }}m"
            selector:
              namespaces:
                - dx02
              labelSelectors:
                "app": "dx02"
            stressors:
              memory:
                workers: 1
                size: "256MB"
          EOF
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "âœ… [DRY RUN] Memory Stress configured but not executed"
            kubectl delete stresschaos memory-stress-experiment -n ${{ env.CHAOS_NAMESPACE }}
          else
            echo "âš ï¸ Memory stress active: 256MB for ${{ github.event.inputs.duration_minutes }} minutes"
          fi

  validate-resilience:
    name: âœ… Validate System Resilience
    runs-on: ubuntu-latest
    needs: [run-pod-chaos, run-network-latency, run-cpu-stress, run-memory-stress]
    if: always() && github.event.inputs.dry_run == 'false'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ¯ Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: ğŸ“Š Check application health
        run: |
          echo "======================================"
          echo "ğŸ“Š System Health After Chaos"
          echo "======================================"
          echo ""
          
          echo "ğŸ” Checking pods..."
          kubectl get pods -n dx02
          echo ""
          
          echo "ğŸ” Checking services..."
          kubectl get svc -n dx02
          echo ""
          
          echo "ğŸ” Checking HPA..."
          kubectl get hpa -n dx02
          echo ""
          
          echo "ğŸ” Recent logs (last 50 lines)..."
          kubectl logs -n dx02 -l app=dx02 --tail=50 --prefix=true
          echo ""
          
          echo "======================================"
          echo "âœ… Validation completed"
          echo "======================================"

      - name: ğŸ§¹ Cleanup chaos experiments
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up chaos experiments..."
          kubectl delete podchaos --all -n ${{ env.CHAOS_NAMESPACE }} --ignore-not-found=true
          kubectl delete networkchaos --all -n ${{ env.CHAOS_NAMESPACE }} --ignore-not-found=true
          kubectl delete stresschaos --all -n ${{ env.CHAOS_NAMESPACE }} --ignore-not-found=true
          echo "âœ… Cleanup completed"

      - name: ğŸ“Š Final Summary
        run: |
          echo "======================================"
          echo "ğŸ‰ Chaos Engineering - Summary"
          echo "======================================"
          echo ""
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Experiment Type: ${{ github.event.inputs.experiment_type }}"
          echo "Duration: ${{ github.event.inputs.duration_minutes }} minutes"
          echo "Dry Run: ${{ github.event.inputs.dry_run }}"
          echo ""
          echo "âœ… All experiments completed"
          echo ""
          echo "ğŸ“š Next steps:"
          echo "1. Analyze logs and metrics in Grafana"
          echo "2. Check alerts in Azure Monitor"
          echo "3. Adjust resilience policies if needed"
          echo "4. Run new experiments to validate improvements"
          echo ""
          echo "ğŸ’¡ Tip: Use dry_run=false to execute real experiments"
