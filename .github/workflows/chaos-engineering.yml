name: üî• Azure Chaos Engineering

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        type: choice
        options:
          - prd
          - stg
        default: prd
      experiment_type:
        description: 'Type of chaos experiment'
        required: true
        type: choice
        options:
          - pod-chaos
          - network-latency
          - cpu-stress
          - memory-stress
          - node-shutdown
          - all-experiments
        default: pod-chaos
      duration_minutes:
        description: 'Duration of experiment (minutes)'
        required: true
        type: number
        default: 5
      dry_run:
        description: 'Dry run (validate without executing)'
        required: true
        type: boolean
        default: true

permissions:
  contents: read
  id-token: write

env:
  AZURE_RESOURCE_GROUP: tx02-${{ github.event.inputs.environment }}-rg
  AKS_CLUSTER_NAME: tx02-${{ github.event.inputs.environment }}-aks
  LOCATION: eastus
  CHAOS_NAMESPACE: chaos-testing

jobs:
  setup-chaos-studio:
    name: üéØ Setup Azure Chaos Studio
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üéØ Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: üîç Check if Chaos Studio is enabled
        id: check-chaos
        run: |
          echo "üîç Checking Azure Chaos Studio status..."
          
          # Check if AKS cluster is chaos-enabled
          CHAOS_ENABLED=$(az rest \
            --method get \
            --url "https://management.azure.com/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${{ env.AZURE_RESOURCE_GROUP }}/providers/Microsoft.ContainerService/managedClusters/${{ env.AKS_CLUSTER_NAME }}/providers/Microsoft.Chaos/targets/microsoft-agent?api-version=2023-11-01" \
            --query properties.provisioningState -o tsv 2>/dev/null || echo "NotEnabled")
          
          if [ "$CHAOS_ENABLED" == "Succeeded" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Chaos Studio j√° est√° habilitado no AKS"
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "üì¶ Chaos Studio n√£o est√° habilitado"
          fi

      - name: üîß Enable Chaos Studio on AKS
        if: steps.check-chaos.outputs.enabled == 'false'
        run: |
          echo "üîß Habilitando Azure Chaos Studio no cluster AKS..."
          
          # Get AKS resource ID
          AKS_RESOURCE_ID=$(az aks show \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --query id -o tsv)
          
          echo "AKS Resource ID: $AKS_RESOURCE_ID"
          
          # Enable Chaos Studio on AKS cluster
          az rest \
            --method put \
            --url "https://management.azure.com${AKS_RESOURCE_ID}/providers/Microsoft.Chaos/targets/microsoft-agent?api-version=2023-11-01" \
            --body '{
              "properties": {}
            }'
          
          echo "‚úÖ Chaos Studio habilitado no AKS"

      - name: üì¶ Install Chaos Mesh
        run: |
          echo "üì¶ Instalando Chaos Mesh no cluster..."
          
          # Add Chaos Mesh Helm repository
          helm repo add chaos-mesh https://charts.chaos-mesh.org
          helm repo update
          
          # Create namespace
          kubectl create namespace ${{ env.CHAOS_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          
          # Check if Chaos Mesh is already installed
          if helm list -n ${{ env.CHAOS_NAMESPACE }} | grep -q "chaos-mesh"; then
            echo "‚ö†Ô∏è Chaos Mesh j√° est√° instalado, atualizando..."
            helm upgrade chaos-mesh chaos-mesh/chaos-mesh \
              --namespace ${{ env.CHAOS_NAMESPACE }} \
              --version 2.6.3 \
              --set chaosDaemon.runtime=containerd \
              --set chaosDaemon.socketPath=/run/containerd/containerd.sock \
              --set dashboard.create=true \
              --set dashboard.securityMode=false
          else
            echo "üì¶ Instalando Chaos Mesh..."
            helm install chaos-mesh chaos-mesh/chaos-mesh \
              --namespace ${{ env.CHAOS_NAMESPACE }} \
              --version 2.6.3 \
              --set chaosDaemon.runtime=containerd \
              --set chaosDaemon.socketPath=/run/containerd/containerd.sock \
              --set dashboard.create=true \
              --set dashboard.securityMode=false
          fi
          
          echo "‚úÖ Chaos Mesh instalado"

      - name: ‚è≥ Wait for Chaos Mesh to be ready
        run: |
          echo "‚è≥ Aguardando Chaos Mesh ficar pronto..."
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/component=controller-manager \
            -n ${{ env.CHAOS_NAMESPACE }} \
            --timeout=300s
          
          echo "‚úÖ Chaos Mesh est√° pronto"

      - name: üìä Display Chaos Mesh status
        run: |
          echo "======================================"
          echo "üî• Chaos Mesh Status"
          echo "======================================"
          echo ""
          kubectl get pods -n ${{ env.CHAOS_NAMESPACE }}
          echo ""
          echo "======================================"
          echo "üìä Chaos Mesh CRDs installed:"
          echo "======================================"
          kubectl get crds | grep chaos-mesh.org

  run-pod-chaos:
    name: üé≤ Pod Chaos (Kill Pods)
    runs-on: ubuntu-latest
    needs: setup-chaos-studio
    if: |
      github.event.inputs.experiment_type == 'pod-chaos' || 
      github.event.inputs.experiment_type == 'all-experiments'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üéØ Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: üé≤ Run Pod Chaos Experiment
        run: |
          echo "üé≤ Executando Pod Chaos (Kill Random Pod)..."
          
          cat <<EOF | kubectl apply -f -
          apiVersion: chaos-mesh.org/v1alpha1
          kind: PodChaos
          metadata:
            name: pod-kill-experiment
            namespace: ${{ env.CHAOS_NAMESPACE }}
          spec:
            action: pod-kill
            mode: one
            duration: "${{ github.event.inputs.duration_minutes }}m"
            selector:
              namespaces:
                - dx02
              labelSelectors:
                "app": "dx02"
            scheduler:
              cron: "@every 2m"
          EOF
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "‚úÖ [DRY RUN] Pod Chaos configurado mas n√£o executado"
            kubectl delete podchaos pod-kill-experiment -n ${{ env.CHAOS_NAMESPACE }}
          else
            echo "‚ö†Ô∏è Experimento de Chaos ATIVO por ${{ github.event.inputs.duration_minutes }} minutos"
            echo "üî• Pods ser√£o mortos a cada 2 minutos"
          fi

      - name: üìä Monitor experiment (if not dry run)
        if: github.event.inputs.dry_run == 'false'
        run: |
          echo "üìä Monitorando experimento..."
          sleep 30
          
          echo "Pods no namespace dx02:"
          kubectl get pods -n dx02
          
          echo ""
          echo "Chaos experiments ativos:"
          kubectl get podchaos -n ${{ env.CHAOS_NAMESPACE }}

  run-network-latency:
    name: üåê Network Latency
    runs-on: ubuntu-latest
    needs: setup-chaos-studio
    if: |
      github.event.inputs.experiment_type == 'network-latency' || 
      github.event.inputs.experiment_type == 'all-experiments'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üéØ Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: üåê Run Network Latency Experiment
        run: |
          echo "üåê Injetando lat√™ncia na rede (200ms)..."
          
          cat <<EOF | kubectl apply -f -
          apiVersion: chaos-mesh.org/v1alpha1
          kind: NetworkChaos
          metadata:
            name: network-latency-experiment
            namespace: ${{ env.CHAOS_NAMESPACE }}
          spec:
            action: delay
            mode: one
            duration: "${{ github.event.inputs.duration_minutes }}m"
            selector:
              namespaces:
                - dx02
              labelSelectors:
                "app": "dx02"
            delay:
              latency: "200ms"
              correlation: "0"
              jitter: "50ms"
          EOF
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "‚úÖ [DRY RUN] Network Latency configurado mas n√£o executado"
            kubectl delete networkchaos network-latency-experiment -n ${{ env.CHAOS_NAMESPACE }}
          else
            echo "‚ö†Ô∏è Lat√™ncia de rede injetada: 200ms ¬± 50ms por ${{ github.event.inputs.duration_minutes }} minutos"
          fi

  run-cpu-stress:
    name: üî• CPU Stress Test
    runs-on: ubuntu-latest
    needs: setup-chaos-studio
    if: |
      github.event.inputs.experiment_type == 'cpu-stress' || 
      github.event.inputs.experiment_type == 'all-experiments'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üéØ Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: üî• Run CPU Stress Experiment
        run: |
          echo "üî• Aplicando stress de CPU (80%)..."
          
          cat <<EOF | kubectl apply -f -
          apiVersion: chaos-mesh.org/v1alpha1
          kind: StressChaos
          metadata:
            name: cpu-stress-experiment
            namespace: ${{ env.CHAOS_NAMESPACE }}
          spec:
            mode: one
            duration: "${{ github.event.inputs.duration_minutes }}m"
            selector:
              namespaces:
                - dx02
              labelSelectors:
                "app": "dx02"
            stressors:
              cpu:
                workers: 2
                load: 80
          EOF
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "‚úÖ [DRY RUN] CPU Stress configurado mas n√£o executado"
            kubectl delete stresschaos cpu-stress-experiment -n ${{ env.CHAOS_NAMESPACE }}
          else
            echo "‚ö†Ô∏è CPU stress ativo: 80% em 2 workers por ${{ github.event.inputs.duration_minutes }} minutos"
          fi

  run-memory-stress:
    name: üíæ Memory Stress Test
    runs-on: ubuntu-latest
    needs: setup-chaos-studio
    if: |
      github.event.inputs.experiment_type == 'memory-stress' || 
      github.event.inputs.experiment_type == 'all-experiments'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üéØ Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: üíæ Run Memory Stress Experiment
        run: |
          echo "üíæ Aplicando stress de mem√≥ria (256MB)..."
          
          cat <<EOF | kubectl apply -f -
          apiVersion: chaos-mesh.org/v1alpha1
          kind: StressChaos
          metadata:
            name: memory-stress-experiment
            namespace: ${{ env.CHAOS_NAMESPACE }}
          spec:
            mode: one
            duration: "${{ github.event.inputs.duration_minutes }}m"
            selector:
              namespaces:
                - dx02
              labelSelectors:
                "app": "dx02"
            stressors:
              memory:
                workers: 1
                size: "256MB"
          EOF
          
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "‚úÖ [DRY RUN] Memory Stress configurado mas n√£o executado"
            kubectl delete stresschaos memory-stress-experiment -n ${{ env.CHAOS_NAMESPACE }}
          else
            echo "‚ö†Ô∏è Memory stress ativo: 256MB por ${{ github.event.inputs.duration_minutes }} minutos"
          fi

  validate-resilience:
    name: ‚úÖ Validate System Resilience
    runs-on: ubuntu-latest
    needs: [run-pod-chaos, run-network-latency, run-cpu-stress, run-memory-stress]
    if: always() && github.event.inputs.dry_run == 'false'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîê Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: üéØ Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: üìä Check application health
        run: |
          echo "======================================"
          echo "üìä System Health After Chaos"
          echo "======================================"
          echo ""
          
          echo "üîç Verificando pods..."
          kubectl get pods -n dx02
          echo ""
          
          echo "üîç Verificando services..."
          kubectl get svc -n dx02
          echo ""
          
          echo "üîç Verificando HPA..."
          kubectl get hpa -n dx02
          echo ""
          
          echo "üîç Logs recentes (√∫ltimas 50 linhas)..."
          kubectl logs -n dx02 -l app=dx02 --tail=50 --prefix=true
          echo ""
          
          echo "======================================"
          echo "‚úÖ Valida√ß√£o conclu√≠da"
          echo "======================================"

      - name: üßπ Cleanup chaos experiments
        if: always()
        run: |
          echo "üßπ Limpando experimentos de chaos..."
          kubectl delete podchaos --all -n ${{ env.CHAOS_NAMESPACE }} --ignore-not-found=true
          kubectl delete networkchaos --all -n ${{ env.CHAOS_NAMESPACE }} --ignore-not-found=true
          kubectl delete stresschaos --all -n ${{ env.CHAOS_NAMESPACE }} --ignore-not-found=true
          echo "‚úÖ Limpeza conclu√≠da"

      - name: üìä Final Summary
        run: |
          echo "======================================"
          echo "üéâ Chaos Engineering - Summary"
          echo "======================================"
          echo ""
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Experiment Type: ${{ github.event.inputs.experiment_type }}"
          echo "Duration: ${{ github.event.inputs.duration_minutes }} minutes"
          echo "Dry Run: ${{ github.event.inputs.dry_run }}"
          echo ""
          echo "‚úÖ Todos os experimentos conclu√≠dos"
          echo ""
          echo "üìö Pr√≥ximos passos:"
          echo "1. Analise os logs e m√©tricas no Grafana"
          echo "2. Verifique alertas no Azure Monitor"
          echo "3. Ajuste pol√≠ticas de resili√™ncia se necess√°rio"
          echo "4. Execute novos experimentos para validar melhorias"
          echo ""
          echo "üí° Dica: Use dry_run=false para executar experimentos reais"
