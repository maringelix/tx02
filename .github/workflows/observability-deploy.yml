name: ðŸ“Š Deploy Observability Stack

on:
  workflow_dispatch:
    inputs:
      slack_webhook:
        description: 'Slack Webhook URL (optional)'
        required: false
        type: string
      destroy:
        description: 'Destroy stack instead of deploy'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

jobs:
  deploy-observability:
    name: Deploy Prometheus + Grafana + Alertmanager
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
    
    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.13.0'
    
    - name: Get AKS credentials
      run: |
        az aks get-credentials \
          --resource-group tx02-prd-rg \
          --name tx02-prd-aks \
          --overwrite-existing
    
    - name: Verify cluster connectivity
      run: |
        kubectl cluster-info
        kubectl get nodes
    
    - name: Add Helm repositories
      if: ${{ !inputs.destroy }}
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update
    
    - name: Create monitoring namespace
      if: ${{ !inputs.destroy }}
      run: |
        kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
    
    - name: Create Alertmanager config
      if: ${{ !inputs.destroy }}
      env:
        SLACK_WEBHOOK: ${{ inputs.slack_webhook || secrets.SLACK_WEBHOOK_URL || 'https://hooks.slack.com/services/PLACEHOLDER' }}
      run: |
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: Secret
        metadata:
          name: alertmanager-config
          namespace: monitoring
        stringData:
          alertmanager.yaml: |
            global:
              resolve_timeout: 5m
              slack_api_url: '${SLACK_WEBHOOK}'
            
            route:
              group_by: ['alertname', 'cluster', 'service']
              group_wait: 10s
              group_interval: 10s
              repeat_interval: 12h
              receiver: 'slack-notifications'
              routes:
              - match:
                  alertname: Watchdog
                receiver: 'null'
              - match:
                  severity: critical
                receiver: 'slack-notifications'
                continue: true
            
            receivers:
            - name: 'null'
            - name: 'slack-notifications'
              slack_configs:
              - channel: '#dx02-alerts'
                title: '{{ .Status | toUpper }} - DX02 Alert'
                text: |
                  *Alert:* {{ .CommonLabels.alertname }}
                  *Severity:* {{ .CommonLabels.severity }}
                  *Summary:* {{ .CommonAnnotations.summary }}
                  *Description:* {{ .CommonAnnotations.description }}
                  *Cluster:* tx02-prd-aks
                send_resolved: true
        EOF
    
    - name: Install kube-prometheus-stack
      if: ${{ !inputs.destroy }}
      env:
        SLACK_WEBHOOK: ${{ inputs.slack_webhook || secrets.SLACK_WEBHOOK_URL || '' }}
      run: |
        helm upgrade --install kube-prometheus-stack \
          prometheus-community/kube-prometheus-stack \
          --namespace monitoring \
          --values k8s/observability/prometheus-values.yaml \
          --set grafana.adminPassword="${{ secrets.GRAFANA_ADMIN_PASSWORD || 'admin' }}" \
          --set alertmanager.config.global.slack_api_url="${SLACK_WEBHOOK}" \
          --timeout=5m
        
        echo "âœ… Helm chart installed. Pods will start in background."
    
    - name: Deploy ServiceMonitor
      if: ${{ !inputs.destroy }}
      run: |
        kubectl apply -f k8s/observability/servicemonitor.yaml
    
    - name: Deploy Grafana Dashboard
      if: ${{ !inputs.destroy }}
      run: |
        kubectl apply -f k8s/observability/grafana-dashboard.yaml
    
    - name: Deploy Grafana LoadBalancer (optional)
      if: ${{ !inputs.destroy }}
      run: |
        kubectl apply -f k8s/observability/grafana-loadbalancer.yaml || true
        echo "âš ï¸  LoadBalancer may fail due to Azure IP limits. Use port-forward as alternative."
    
    - name: Wait for pods to be ready
      if: ${{ !inputs.destroy }}
      run: |
        echo "Waiting for Prometheus..."
        kubectl wait --for=condition=ready pod \
          -l app.kubernetes.io/name=prometheus \
          -n monitoring \
          --timeout=300s
        
        echo "Waiting for Grafana..."
        kubectl wait --for=condition=ready pod \
          -l app.kubernetes.io/name=grafana \
          -n monitoring \
          --timeout=300s
        
        echo "All pods ready!"
    
    - name: Get deployment status
      if: ${{ !inputs.destroy }}
      run: |
        echo "=== Pods ==="
        kubectl get pods -n monitoring -o wide
        
        echo ""
        echo "=== Services ==="
        kubectl get svc -n monitoring
        
        echo ""
        echo "=== PersistentVolumeClaims ==="
        kubectl get pvc -n monitoring
    
    - name: Display access instructions
      if: ${{ !inputs.destroy }}
      run: |
        echo "========================================"
        echo "âœ… Observability Stack Deployed!"
        echo "========================================"
        echo ""
        echo "ðŸ“Š Access Grafana:"
        echo "  Port-forward (recommended):"
        echo "    kubectl port-forward -n monitoring svc/kube-prometheus-stack-grafana 8080:80"
        echo "    http://localhost:8080"
        echo ""
        echo "  LoadBalancer (if provisioned):"
        EXTERNAL_IP=$(kubectl get svc -n monitoring grafana-external -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "<pending or failed>")
        echo "    http://$EXTERNAL_IP"
        echo ""
        echo "ðŸ”‘ Credentials:"
        echo "    Username: admin"
        echo "    Password: ${{ secrets.GRAFANA_ADMIN_PASSWORD || 'admin' }}"
        echo ""
        echo "ðŸ“š Documentation:"
        echo "    See k8s/observability/ACCESS.md for details"
        echo "  Password: ${{ secrets.GRAFANA_ADMIN_PASSWORD || 'admin' }}"
        echo ""
        echo "Access Prometheus:"
        echo "  kubectl port-forward -n monitoring svc/kube-prometheus-stack-prometheus 9090:9090"
        echo "  http://localhost:9090"
        echo ""
        echo "Access Alertmanager:"
        echo "  kubectl port-forward -n monitoring svc/kube-prometheus-stack-alertmanager 9093:9093"
        echo "  http://localhost:9093"
        echo ""
    
    - name: Uninstall observability stack
      if: ${{ inputs.destroy }}
      run: |
        echo "Destroying observability stack..."
        
        helm uninstall kube-prometheus-stack -n monitoring || true
        
        kubectl delete namespace monitoring --wait=false || true
        
        echo "Observability stack destroyed!"
    
    - name: Send Slack notification on success
      if: ${{ success() && !inputs.destroy }}
      env:
        SLACK_WEBHOOK: ${{ inputs.slack_webhook || secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ -n "$SLACK_WEBHOOK" ] && [ "$SLACK_WEBHOOK" != "https://hooks.slack.com/services/PLACEHOLDER" ]; then
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d '{
              "text": ":white_check_mark: DX02 Observability Stack Deployed Successfully",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*DX02 Observability Stack Deployed*\n\nPrometheus, Grafana, and Alertmanager are now running in the `monitoring` namespace."
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Cluster:*\ntx02-prd-aks"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Namespace:*\nmonitoring"
                    }
                  ]
                }
              ]
            }'
        fi
    
    - name: Send Slack notification on failure
      if: ${{ failure() }}
      env:
        SLACK_WEBHOOK: ${{ inputs.slack_webhook || secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ -n "$SLACK_WEBHOOK" ] && [ "$SLACK_WEBHOOK" != "https://hooks.slack.com/services/PLACEHOLDER" ]; then
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d '{
              "text": ":x: DX02 Observability Stack Deployment Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*DX02 Observability Stack Deployment Failed*\n\nCheck the GitHub Actions logs for details."
                  }
                }
              ]
            }'
        fi
