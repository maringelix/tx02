name: Bootstrap - Setup Terraform Backend

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
        default: 'plan'
      confirm:
        description: 'Type "bootstrap" to confirm (only for apply)'
        required: false

env:
  RESOURCE_GROUP: terraform-state-rg
  STORAGE_ACCOUNT: tfstatetx02
  CONTAINER_NAME: tfstate
  LOCATION: eastus

jobs:
  plan:
    name: Show What Will Be Created
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'plan'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Extract Azure Credentials
        id: azure-creds
        run: |
          echo "CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientId')" >> $GITHUB_OUTPUT
          echo "CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientSecret')" >> $GITHUB_OUTPUT
          echo "TENANT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.tenantId')" >> $GITHUB_OUTPUT
          echo "SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.subscriptionId')" >> $GITHUB_OUTPUT
      
      - name: Azure CLI Login
        run: |
          az login --service-principal \
            -u "${{ steps.azure-creds.outputs.CLIENT_ID }}" \
            -p "${{ steps.azure-creds.outputs.CLIENT_SECRET }}" \
            --tenant "${{ steps.azure-creds.outputs.TENANT_ID }}"
          
          az account set --subscription "${{ steps.azure-creds.outputs.SUBSCRIPTION_ID }}"
          
          echo "âœ… Logged in as Service Principal"
          az account show
      
      - name: Check if Resources Already Exist
        id: check
        run: |
          echo "## ðŸ” Checking Current State..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check Resource Group
          if az group show --name ${{ env.RESOURCE_GROUP }} &>/dev/null; then
            echo "RG_EXISTS=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ **Resource Group** \`${{ env.RESOURCE_GROUP }}\` **already exists**" >> $GITHUB_STEP_SUMMARY
          else
            echo "RG_EXISTS=false" >> $GITHUB_OUTPUT
            echo "âœ… Resource Group \`${{ env.RESOURCE_GROUP }}\` will be created" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check Storage Account
          if az storage account show --name ${{ env.STORAGE_ACCOUNT }} --resource-group ${{ env.RESOURCE_GROUP }} &>/dev/null; then
            echo "SA_EXISTS=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ **Storage Account** \`${{ env.STORAGE_ACCOUNT }}\` **already exists**" >> $GITHUB_STEP_SUMMARY
          else
            echo "SA_EXISTS=false" >> $GITHUB_OUTPUT
            echo "âœ… Storage Account \`${{ env.STORAGE_ACCOUNT }}\` will be created" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check Container
          if az storage container show --name ${{ env.CONTAINER_NAME }} --account-name ${{ env.STORAGE_ACCOUNT }} &>/dev/null 2>&1; then
            echo "CONTAINER_EXISTS=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ **Blob Container** \`${{ env.CONTAINER_NAME }}\` **already exists**" >> $GITHUB_STEP_SUMMARY
          else
            echo "CONTAINER_EXISTS=false" >> $GITHUB_OUTPUT
            echo "âœ… Blob Container \`${{ env.CONTAINER_NAME }}\` will be created" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Show Bootstrap Plan
        run: |
          echo "## ðŸ“‹ Bootstrap Plan - Resources to be Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Location | \`${{ env.LOCATION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | \`${{ env.RESOURCE_GROUP }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Storage Account | \`${{ env.STORAGE_ACCOUNT }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Container | \`${{ env.CONTAINER_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ—ï¸ Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### 1. Resource Group" >> $GITHUB_STEP_SUMMARY
          echo "- **Name**: \`${{ env.RESOURCE_GROUP }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Location**: \`${{ env.LOCATION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags**:" >> $GITHUB_STEP_SUMMARY
          echo "  - Environment: shared" >> $GITHUB_STEP_SUMMARY
          echo "  - Purpose: terraform-state" >> $GITHUB_STEP_SUMMARY
          echo "  - ManagedBy: GitHub-Actions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### 2. Storage Account" >> $GITHUB_STEP_SUMMARY
          echo "- **Name**: \`${{ env.STORAGE_ACCOUNT }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **SKU**: Standard_LRS (Locally Redundant Storage)" >> $GITHUB_STEP_SUMMARY
          echo "- **Features**:" >> $GITHUB_STEP_SUMMARY
          echo "  - âœ… Encryption at rest (AES-256)" >> $GITHUB_STEP_SUMMARY
          echo "  - âœ… HTTPS only" >> $GITHUB_STEP_SUMMARY
          echo "  - âœ… TLS 1.2 minimum" >> $GITHUB_STEP_SUMMARY
          echo "  - âœ… Public access disabled" >> $GITHUB_STEP_SUMMARY
          echo "  - âœ… Blob versioning enabled" >> $GITHUB_STEP_SUMMARY
          echo "  - âœ… Soft delete (7 days)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### 3. Blob Container" >> $GITHUB_STEP_SUMMARY
          echo "- **Name**: \`${{ env.CONTAINER_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Purpose**: Store Terraform state files" >> $GITHUB_STEP_SUMMARY
          echo "- **Access**: Private (authenticated users only)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### 4. IAM Permissions" >> $GITHUB_STEP_SUMMARY
          echo "- **Service Principal**: github-actions-tx02" >> $GITHUB_STEP_SUMMARY
          echo "- **Role**: Storage Blob Data Contributor" >> $GITHUB_STEP_SUMMARY
          echo "- **Scope**: Storage Account \`${{ env.STORAGE_ACCOUNT }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ’° Estimated Costs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Estimated Cost/Month |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Storage Account (LRS) | ~\$2 USD |" >> $GITHUB_STEP_SUMMARY
          echo "| Blob Storage (~1GB) | ~\$0.02 USD |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **~\$2.02 USD/month** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### âš¡ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To apply this configuration:" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the plan above" >> $GITHUB_STEP_SUMMARY
          echo "2. Run this workflow again" >> $GITHUB_STEP_SUMMARY
          echo "3. Select **apply** as action" >> $GITHUB_STEP_SUMMARY
          echo "4. Type **bootstrap** in the confirmation field" >> $GITHUB_STEP_SUMMARY
          echo "5. Click **Run workflow**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Note**: No resources will be created in PLAN mode." >> $GITHUB_STEP_SUMMARY
      
      - name: Check Subscription Credits
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’³ Subscription Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          SUB_INFO=$(az account show --query "{Name:name, State:state, SubscriptionId:id}" -o json)
          SUB_NAME=$(echo $SUB_INFO | jq -r '.Name')
          SUB_STATE=$(echo $SUB_INFO | jq -r '.State')
          SUB_ID=$(echo $SUB_INFO | jq -r '.SubscriptionId')
          
          echo "- **Name**: \`$SUB_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ID**: \`$SUB_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "- **State**: \`$SUB_STATE\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Bootstrap plan completed successfully!" >> $GITHUB_STEP_SUMMARY
  
  bootstrap:
    name: Setup Terraform State Backend
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'apply'
    
    steps:
      - name: Validate confirmation
        if: github.event.inputs.confirm != 'bootstrap'
        run: |
          echo "âŒ Confirmation failed. You must type 'bootstrap' to proceed."
          echo "## âŒ Bootstrap Apply Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reason**: Confirmation text was not 'bootstrap'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To proceed:" >> $GITHUB_STEP_SUMMARY
          echo "1. Run the workflow again" >> $GITHUB_STEP_SUMMARY
          echo "2. Select **apply** as action" >> $GITHUB_STEP_SUMMARY
          echo "3. Type exactly: **bootstrap**" >> $GITHUB_STEP_SUMMARY
          exit 1
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Extract Azure Credentials
        id: azure-creds
        run: |
          echo "CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientId')" >> $GITHUB_OUTPUT
          echo "CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientSecret')" >> $GITHUB_OUTPUT
          echo "TENANT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.tenantId')" >> $GITHUB_OUTPUT
          echo "SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.subscriptionId')" >> $GITHUB_OUTPUT
      
      - name: Azure CLI Login
        run: |
          az login --service-principal \
            -u "${{ steps.azure-creds.outputs.CLIENT_ID }}" \
            -p "${{ steps.azure-creds.outputs.CLIENT_SECRET }}" \
            --tenant "${{ steps.azure-creds.outputs.TENANT_ID }}"
          
          az account set --subscription "${{ steps.azure-creds.outputs.SUBSCRIPTION_ID }}"
          
          echo "âœ… Logged in as Service Principal"
          az account show
      
      - name: Create Resource Group for Terraform State
        run: |
          echo "ðŸ“¦ Creating Resource Group: ${{ env.RESOURCE_GROUP }}"
          az group create \
            --name ${{ env.RESOURCE_GROUP }} \
            --location ${{ env.LOCATION }} \
            --tags Environment=shared Purpose=terraform-state ManagedBy=GitHub-Actions
          
          echo "âœ… Resource Group created successfully"
      
      - name: Create Storage Account for Terraform State
        run: |
          # Revalidar subscription antes de criar storage account
          az account set --subscription "${{ steps.azure-creds.outputs.SUBSCRIPTION_ID }}"
          
          echo "ðŸ’¾ Creating Storage Account: ${{ env.STORAGE_ACCOUNT }}"
          az storage account create \
            --name ${{ env.STORAGE_ACCOUNT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --location ${{ env.LOCATION }} \
            --sku Standard_LRS \
            --subscription "${{ steps.azure-creds.outputs.SUBSCRIPTION_ID }}" \
            --encryption-services blob \
            --https-only true \
            --min-tls-version TLS1_2 \
            --allow-blob-public-access false \
            --tags Environment=shared Purpose=terraform-state ManagedBy=GitHub-Actions
          
          echo "âœ… Storage Account created successfully"
      
      - name: Enable Versioning on Storage Account
        run: |
          echo "ðŸ”„ Enabling versioning on storage account..."
          az storage account blob-service-properties update \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --subscription "${{ steps.azure-creds.outputs.SUBSCRIPTION_ID }}" \
            --enable-versioning true
          
          echo "âœ… Versioning enabled"
      
      - name: Create Blob Container for Terraform State
        run: |
          echo "ðŸ“ Creating Blob Container: ${{ env.CONTAINER_NAME }}"
          az storage container create \
            --name ${{ env.CONTAINER_NAME }} \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --auth-mode login
          
          echo "âœ… Blob Container created successfully"
      
      - name: Configure Blob Container for State Locking
        run: |
          echo "ðŸ”’ Configuring blob properties for state locking..."
          az storage blob service-properties update \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --subscription "${{ steps.azure-creds.outputs.SUBSCRIPTION_ID }}" \
            --enable-delete-retention true \
            --delete-retention-days 7
          
          echo "âœ… State locking configured"
      
      - name: Grant Service Principal Access
        run: |
          echo "ðŸ” Granting Service Principal access to Storage Account..."
          
          SP_ID=$(az ad sp list --display-name "github-actions-tx02" --query "[0].id" -o tsv)
          STORAGE_ID=$(az storage account show --name ${{ env.STORAGE_ACCOUNT }} --resource-group ${{ env.RESOURCE_GROUP }} --query id -o tsv)
          
          # Storage Blob Data Contributor role
          az role assignment create \
            --assignee $SP_ID \
            --role "Storage Blob Data Contributor" \
            --scope $STORAGE_ID
          
          echo "âœ… Permissions granted successfully"
      
      - name: Test Terraform Backend Connection
        run: |
          echo "ðŸ§ª Testing Terraform backend connection..."
          
          # Create a minimal Terraform config to test backend
          cat > test-backend.tf << 'EOF'
          terraform {
            backend "azurerm" {
              resource_group_name  = "${{ env.RESOURCE_GROUP }}"
              storage_account_name = "${{ env.STORAGE_ACCOUNT }}"
              container_name       = "${{ env.CONTAINER_NAME }}"
              key                  = "bootstrap-test.tfstate"
            }
          }
          EOF
          
          # Install Terraform
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt update && sudo apt install terraform
          
          # Test backend init
          terraform init
          
          echo "âœ… Terraform backend connection successful!"
          
          # Cleanup test file
          rm test-backend.tf
      
      - name: Summary
        run: |
          echo "## âœ… Bootstrap Completed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Terraform Backend Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | \`${{ env.RESOURCE_GROUP }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Storage Account | \`${{ env.STORAGE_ACCOUNT }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Container | \`${{ env.CONTAINER_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Location | \`${{ env.LOCATION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Backend storage configured" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… Service Principal has access" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸš€ Ready to run Terraform Apply workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**You can now create infrastructure using the Terraform Apply workflow!**" >> $GITHUB_STEP_SUMMARY
