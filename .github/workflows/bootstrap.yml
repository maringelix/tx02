name: Bootstrap - Setup Terraform Backend

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
        default: 'plan'
      confirm:
        description: 'Type "bootstrap" to confirm (only for apply)'
        required: false

env:
  RESOURCE_GROUP: terraform-state-rg
  STORAGE_ACCOUNT: tfstatetx02
  CONTAINER_NAME: tfstate
  LOCATION: eastus

jobs:
  plan:
    name: Show What Will Be Created
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'plan'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Extract Azure Credentials
        id: azure-creds
        run: |
          echo "CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientId')" >> $GITHUB_OUTPUT
          echo "CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientSecret')" >> $GITHUB_OUTPUT
          echo "TENANT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.tenantId')" >> $GITHUB_OUTPUT
          echo "SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.subscriptionId')" >> $GITHUB_OUTPUT
      
      - name: Azure CLI Login
        run: |
          az login --service-principal \
            -u "${{ steps.azure-creds.outputs.CLIENT_ID }}" \
            -p "${{ steps.azure-creds.outputs.CLIENT_SECRET }}" \
            --tenant "${{ steps.azure-creds.outputs.TENANT_ID }}"
          
          az account set --subscription "${{ steps.azure-creds.outputs.SUBSCRIPTION_ID }}"
          
          echo "âœ… Logged in as Service Principal"
          az account show
      
      - name: Check if Resources Already Exist
        id: check
        run: |
          echo "## ðŸ” Checking Current State..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check Resource Group
          if az group show --name ${{ env.RESOURCE_GROUP }} &>/dev/null; then
            echo "RG_EXISTS=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ **Resource Group** \`${{ env.RESOURCE_GROUP }}\` **already exists**" >> $GITHUB_STEP_SUMMARY
          else
            echo "RG_EXISTS=false" >> $GITHUB_OUTPUT
            echo "âœ… Resource Group \`${{ env.RESOURCE_GROUP }}\` will be created" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check Storage Account
          if az storage account show --name ${{ env.STORAGE_ACCOUNT }} --resource-group ${{ env.RESOURCE_GROUP }} &>/dev/null; then
            echo "SA_EXISTS=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ **Storage Account** \`${{ env.STORAGE_ACCOUNT }}\` **already exists**" >> $GITHUB_STEP_SUMMARY
          else
            echo "SA_EXISTS=false" >> $GITHUB_OUTPUT
            echo "âœ… Storage Account \`${{ env.STORAGE_ACCOUNT }}\` will be created" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check Container
          if az storage container show --name ${{ env.CONTAINER_NAME }} --account-name ${{ env.STORAGE_ACCOUNT }} &>/dev/null 2>&1; then
            echo "CONTAINER_EXISTS=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ **Blob Container** \`${{ env.CONTAINER_NAME }}\` **already exists**" >> $GITHUB_STEP_SUMMARY
          else
            echo "CONTAINER_EXISTS=false" >> $GITHUB_OUTPUT
            echo "âœ… Blob Container \`${{ env.CONTAINER_NAME }}\` will be created" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Show Bootstrap Plan
        run: |
          echo "## ðŸ“‹ Bootstrap Plan - Resources to be Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Location | \`${{ env.LOCATION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | \`${{ env.RESOURCE_GROUP }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Storage Account | \`${{ env.STORAGE_ACCOUNT }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Container | \`${{ env.CONTAINER_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš¡ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To apply: Run workflow again with action=**apply** and confirm=**bootstrap**" >> $GITHUB_STEP_SUMMARY
  
  bootstrap:
    name: Setup Terraform State Backend
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'apply'
    
    steps:
      - name: Validate confirmation
        if: github.event.inputs.confirm != 'bootstrap'
        run: |
          echo "âŒ Confirmation failed. You must type 'bootstrap' to proceed."
          echo "## âŒ Bootstrap Apply Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reason**: Confirmation text was not 'bootstrap'" >> $GITHUB_STEP_SUMMARY
          exit 1
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Azure Login and Create Infrastructure
          
          # ===== STEP 1: Resource Group =====
          echo "ðŸ“¦ Creating Resource Group: ${{ env.RESOURCE_GROUP }}"
          az group create \
            --name ${{ env.RESOURCE_GROUP }} \
            --location ${{ env.LOCATION }} \
            --subscription "${{ steps.azure-creds.outputs.SUBSCRIPTION_ID }}" \
            --tags Environment=shared Purpose=terraform-state ManagedBy=GitHub-Actions
          
          echo "âœ… Resource Group created successfully"
          echo ""
          
          # ===== DEBUG: Verify subscription context =====
          echo "ðŸ” Verifying subscription context before storage account creation..."
          az account show
          az account set --subscription "$ARM_SUBSCRIPTION_ID"
          
          # Wait for resource group to fully propagate
          echo "â³ Waiting 10 seconds for resource group propagation..."
          sleep 10
          
          # Verify resource group exists
          echo "ðŸ” Verifying resource group exists..."
          az group show --name ${{ env.RESOURCE_GROUP }}
          echo ""
          
          # ===== STEP 2: Storage Account =====
          echo "ðŸ’¾ Creating Storage Account: ${{ env.STORAGE_ACCOUNT }}"
          az storage account create \
            --name ${{ env.STORAGE_ACCOUNT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --location ${{ env.LOCATION }} \
            --sku Standard_LRS \
            --encryption-services blob \
            --https-only true \
            --min-tls-version TLS1_2 \
            --allow-blob-public-access false \
            --tags Environment=shared Purpose=terraform-state ManagedBy=GitHub-Actions
          
          echo "âœ… Storage Account created successfully"
          echo ""
          
          # ===== STEP 3: Enable Versioning =====
          echo "ðŸ”„ Enabling versioning on storage account..."
          az storage account blob-service-properties update \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --subscription "${{ steps.azure-creds.outputs.SUBSCRIPTION_ID }}" \
            --enable-versioning true
          
          echo "âœ… Versioning enabled"
          echo ""
          
          # ===== STEP 4: Create Blob Container =====
          echo "ðŸ“ Creating Blob Container: ${{ env.CONTAINER_NAME }}"
          az storage container create \
            --name ${{ env.CONTAINER_NAME }} \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --auth-mode login
          
          echo "âœ… Blob Container created successfully"
          echo ""
          
          # ===== STEP 5: Configure Soft Delete =====
          echo "ðŸ”’ Configuring soft delete (7 days retention)..."
          az storage blob service-properties update \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --subscription "${{ steps.azure-creds.outputs.SUBSCRIPTION_ID }}" \
            --enable-delete-retention true \
            --delete-retention-days 7
          
          echo "âœ… Soft delete configured"
          echo ""
          
          # ===== STEP 6: Grant Service Principal Access =====
          echo "ðŸ” Granting Service Principal access to Storage Account..."
          SP_ID="${{ steps.azure-creds.outputs.CLIENT_ID }}"
          STORAGE_ID=$(az storage account show \
            --name ${{ env.STORAGE_ACCOUNT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --subscription "${{ steps.azure-creds.outputs.SUBSCRIPTION_ID }}" \
            --query id -o tsv)
          
          az role assignment create \
            --assignee "${SP_ID}" \
            --role "Storage Blob Data Contributor" \
            --scope "${STORAGE_ID}" \
            --subscription "${{ steps.azure-creds.outputs.SUBSCRIPTION_ID }}"
          
          echo "âœ… Permissions granted successfully"
          echo ""
          echo "ðŸŽ‰ Bootstrap completed successfully!"
      
      - name: Summary
        run: |
          echo "## âœ… Bootstrap Completed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Terraform Backend Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | \`${{ env.RESOURCE_GROUP }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Storage Account | \`${{ env.STORAGE_ACCOUNT }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Container | \`${{ env.CONTAINER_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Location | \`${{ env.LOCATION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Backend storage configured" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… Service Principal has access" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸš€ Ready to run Terraform Apply workflow" >> $GITHUB_STEP_SUMMARY
