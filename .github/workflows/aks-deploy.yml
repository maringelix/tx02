name: ☁️ Deploy to AKS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'prd'
        type: choice
        options:
          - prd
          - stg

env:
  AZURE_RESOURCE_GROUP: tx02-prd-rg
  AKS_CLUSTER_NAME: tx02-prd-aks

jobs:
  deploy:
    name: Deploy to AKS
    runs-on: ubuntu-latest
    
    environment:
      name: ${{ github.event.inputs.environment || 'prd' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Set AKS context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.AZURE_RESOURCE_GROUP }}
          cluster-name: ${{ env.AKS_CLUSTER_NAME }}
      
      - name: Create namespace if not exists
        run: |
          kubectl create namespace dx02 --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Create database secret
        env:
          DB_PASSWORD: ${{ secrets.AZURE_SQL_PASSWORD }}
        run: |
          kubectl create secret generic dx02-secrets \
            --from-literal=db-host=tx02-prd-sql.database.windows.net \
            --from-literal=db-name=tx02-prd-db \
            --from-literal=db-user=tx02 \
            --from-literal=db-password="$DB_PASSWORD" \
            --namespace=dx02 \
            --dry-run=client -o yaml | kubectl apply -f -
          
          kubectl create secret generic appinsights-config \
            --from-literal=connection-string="" \
            --namespace=dx02 \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Create Azure Container Registry secret
        run: |
          kubectl create secret docker-registry acr-secret \
            --docker-server=tx02prdacr.azurecr.io \
            --docker-username=${{ secrets.ACR_USERNAME }} \
            --docker-password=${{ secrets.ACR_PASSWORD }} \
            --namespace=dx02 \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Clean up old resources
        run: |
          echo "=== Before cleanup - Deployments ==="
          kubectl get deployments -n dx02 -o wide || true
          echo "=== Before cleanup - ReplicaSets ==="
          kubectl get replicasets -n dx02 -o wide || true
          echo "=== Deleting all resources ==="
          # Force delete ALL resources in namespace to start completely fresh
          kubectl delete all --all -n dx02 || true
          # Give time for cleanup
          sleep 15
          echo "=== After cleanup - Checking if clean ==="
          kubectl get all -n dx02 || true
      
      - name: Deploy Kubernetes manifests
        run: |
          echo "=== Applying manifests from k8s/ ==="
          kubectl apply -f k8s/ -n dx02
          echo "=== Checking what was created ==="
          kubectl get deployments -n dx02 -o wide
          kubectl get replicasets -n dx02 -o wide
      
      - name: Debug - Check pods and events
        if: always()
        run: |
          echo "=== Pods Status ==="
          kubectl get pods -n dx02
          echo ""
          echo "=== Deployment Status ==="
          kubectl get deployment dx02 -n dx02
          echo ""
          echo "=== Recent Events ==="
          kubectl get events -n dx02 --sort-by='.lastTimestamp' | tail -20
          echo ""
          echo "=== Pod Describe (if exists) ==="
          kubectl describe pods -n dx02 | head -100 || true
      
      - name: Wait for deployment
        run: |
          kubectl rollout status deployment/dx02 -n dx02 --timeout=5m
      
      - name: Get service endpoint
        id: get-endpoint
        run: |
          # Get nginx-ingress-controller external IP
          echo "Waiting for nginx-ingress-controller external IP..."
          EXTERNAL_IP=""
          for i in {1..30}; do
            EXTERNAL_IP=$(kubectl get svc ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            if [ -n "$EXTERNAL_IP" ]; then
              break
            fi
            echo "Attempt $i/30: Waiting..."
            sleep 10
          done
          
          if [ -z "$EXTERNAL_IP" ]; then
            echo "❌ Failed to get nginx-ingress external IP"
            exit 1
          fi
          
          echo "endpoint=$EXTERNAL_IP" >> $GITHUB_OUTPUT
          echo "✅ Nginx Ingress IP: $EXTERNAL_IP"
      
      - name: Check certificate status
        run: |
          echo "=== Certificate Status ==="
          kubectl get certificate -n dx02 || echo "No certificates found"
          echo ""
          echo "=== Certificate Details ==="
          kubectl describe certificate dx02-tls-cert -n dx02 2>/dev/null || echo "Certificate dx02-tls-cert not found"
          echo ""
          echo "=== Ingress Status ==="
          kubectl get ingress dx02 -n dx02 -o wide
      
      - name: Health check
        run: |
          sleep 30
          echo "Testing HTTP endpoint: http://${{ steps.get-endpoint.outputs.endpoint }}/health"
          curl -f http://${{ steps.get-endpoint.outputs.endpoint }}/health || echo "⚠️ Health check failed"
          echo ""
          echo "Testing HTTPS endpoint: https://dx02.ddns.net/health"
          curl -f -k https://dx02.ddns.net/health || echo "⚠️ HTTPS health check failed (expected if DNS not updated yet)"
      
      - name: Summary
        run: |
          echo "## ✅ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'prd' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Nginx Ingress IP:** http://${{ steps.get-endpoint.outputs.endpoint }}" >> $GITHUB_STEP_SUMMARY
          echo "**Domain:** https://dx02.ddns.net" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ **Action Required:** Update DNS dx02.ddns.net to point to ${{ steps.get-endpoint.outputs.endpoint }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pods Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n dx02 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
