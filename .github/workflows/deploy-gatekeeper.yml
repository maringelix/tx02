name: ğŸ›¡ï¸ Deploy OPA Gatekeeper

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action'
        required: true
        type: choice
        options:
          - install
          - upgrade
          - uninstall
      apply_policies:
        description: 'Apply Policies'
        required: false
        type: boolean
        default: true

env:
  AZURE_RESOURCE_GROUP: tx02-prd-rg
  AKS_CLUSTER_NAME: tx02-prd-aks
  GATEKEEPER_VERSION: v3.15.0

jobs:
  deploy-gatekeeper:
    name: ğŸ›¡ï¸ ${{ github.event.inputs.action }} OPA Gatekeeper
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: â˜¸ï¸ Configure kubectl for AKS
        run: |
          echo "â˜¸ï¸ Configuring kubectl for AKS..."
          az aks get-credentials \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing
          
          echo "âœ… Kubectl configured"
          kubectl cluster-info
      
      - name: ğŸ” Pre-flight Check
        run: |
          echo "ğŸ” Checking cluster capacity..."
          echo ""
          
          NODE_COUNT=$(kubectl get nodes --no-headers | wc -l)
          TOTAL_PODS=$(kubectl get pods -A --no-headers | wc -l)
          
          echo "ğŸ“Š Cluster Status:"
          echo "   Nodes: $NODE_COUNT"
          echo "   Total pods: $TOTAL_PODS"
          echo ""
          
          # Check if gatekeeper-system namespace exists
          if kubectl get namespace gatekeeper-system &> /dev/null; then
            echo "â„¹ï¸  Gatekeeper namespace already exists"
            EXISTING_PODS=$(kubectl get pods -n gatekeeper-system --no-headers 2>/dev/null | wc -l)
            echo "   Existing Gatekeeper pods: $EXISTING_PODS"
          else
            echo "â„¹ï¸  Gatekeeper will be installed fresh"
          fi
          echo ""
      
      - name: ğŸ¯ Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'
      
      - name: ğŸ“¦ Add Gatekeeper Helm Repository
        run: |
          echo "ğŸ“¦ Adding Gatekeeper Helm repository..."
          helm repo add gatekeeper https://open-policy-agent.github.io/gatekeeper/charts
          helm repo update
          echo "âœ… Repository added and updated"
      
      - name: ğŸ§¹ Cleanup Previous Installation
        if: github.event.inputs.action == 'install'
        run: |
          echo "ğŸ§¹ Cleaning up any previous Gatekeeper installation..."
          
          # Delete namespace (will hang if resources aren't cleaned)
          kubectl delete namespace gatekeeper-system --ignore-not-found=true --timeout=30s || true
          
          # Force cleanup of cluster-scoped resources
          echo "Removing ClusterRoles..."
          kubectl delete clusterrole -l gatekeeper.sh/system=yes --ignore-not-found=true || true
          kubectl delete clusterrole gatekeeper-manager-role --ignore-not-found=true || true
          
          echo "Removing ClusterRoleBindings..."
          kubectl delete clusterrolebinding -l gatekeeper.sh/system=yes --ignore-not-found=true || true
          kubectl delete clusterrolebinding gatekeeper-manager-rolebinding --ignore-not-found=true || true
          
          echo "Removing ValidatingWebhookConfigurations..."
          kubectl delete validatingwebhookconfiguration gatekeeper-validating-webhook-configuration --ignore-not-found=true || true
          
          echo "Removing MutatingWebhookConfigurations..."
          kubectl delete mutatingwebhookconfiguration gatekeeper-mutating-webhook-configuration --ignore-not-found=true || true
          
          echo "Removing CRDs..."
          kubectl get crd -o name | grep gatekeeper | xargs -r kubectl delete --ignore-not-found=true || true
          
          echo "Waiting for cleanup to complete..."
          sleep 10
          
          echo "âœ… Cleanup complete"
      
      - name: ğŸ“ Create Gatekeeper Namespace
        if: github.event.inputs.action == 'install'
        run: |
          echo "ğŸ“ Creating gatekeeper-system namespace..."
          kubectl create namespace gatekeeper-system --dry-run=client -o yaml | kubectl apply -f -
          echo "âœ… Namespace ready"
      
      - name: ğŸ›¡ï¸ Install OPA Gatekeeper
        if: github.event.inputs.action == 'install'
        run: |
          echo "ğŸ›¡ï¸ Installing OPA Gatekeeper..."
          echo ""
          echo "ğŸ¯ Configuration:"
          echo "   âœ… Controller: 2 replicas"
          echo "   âœ… Audit: 1 replica"
          echo "   âœ… Metrics: Enabled for Prometheus"
          echo "   âœ… Webhook timeout: 5s (validating), 2s (mutating)"
          echo ""
          
          helm upgrade --install gatekeeper gatekeeper/gatekeeper \
            --namespace gatekeeper-system \
            --set enableExternalData=false \
            --set validatingWebhookTimeoutSeconds=5 \
            --set mutatingWebhookTimeoutSeconds=2 \
            --set audit.replicas=1 \
            --set replicas=2 \
            --set revisionHistoryLimit=3 \
            --set metrics.enabled=true \
            --set resources.requests.memory=128Mi \
            --set resources.requests.cpu=100m \
            --set resources.limits.memory=256Mi \
            --set resources.limits.cpu=200m \
            --wait --timeout=10m
          
          echo ""
          echo "âœ… Gatekeeper installed successfully"
      
      - name: ğŸ”„ Upgrade OPA Gatekeeper
        if: github.event.inputs.action == 'upgrade'
        run: |
          echo "ğŸ”„ Upgrading OPA Gatekeeper..."
          
          helm upgrade gatekeeper gatekeeper/gatekeeper \
            --namespace gatekeeper-system \
            --set enableExternalData=false \
            --set validatingWebhookTimeoutSeconds=5 \
            --set mutatingWebhookTimeoutSeconds=2 \
            --set audit.replicas=1 \
            --set replicas=2 \
            --set revisionHistoryLimit=3 \
            --set metrics.enabled=true \
            --set resources.requests.memory=128Mi \
            --set resources.requests.cpu=100m \
            --set resources.limits.memory=256Mi \
            --set resources.limits.cpu=200m \
            --wait --timeout=10m
          
          echo "âœ… Gatekeeper upgraded successfully"
      
      - name: â³ Wait for Gatekeeper to be Ready
        if: github.event.inputs.action != 'uninstall'
        run: |
          echo "â³ Waiting for Gatekeeper to be ready..."
          sleep 20
          
          echo "Waiting for controller manager..."
          kubectl wait --for=condition=Available \
            deployment/gatekeeper-controller-manager \
            -n gatekeeper-system \
            --timeout=300s
          
          echo "Waiting for audit..."
          kubectl wait --for=condition=Available \
            deployment/gatekeeper-audit \
            -n gatekeeper-system \
            --timeout=300s
          
          echo "âœ… Gatekeeper is ready"
      
      - name: ğŸ“œ Apply Constraint Templates
        if: github.event.inputs.action != 'uninstall' && github.event.inputs.apply_policies == 'true'
        run: |
          echo "ğŸ“œ Applying Constraint Templates..."
          
          if [ -d "k8s/policies" ]; then
            # Apply constraint templates first
            for template in k8s/policies/constraint-template-*.yaml; do
              if [ -f "$template" ]; then
                echo "  Applying $(basename $template)..."
                kubectl apply -f "$template"
              fi
            done
            
            echo ""
            echo "â³ Waiting for templates to be established (30s)..."
            sleep 30
            
            echo "âœ… Constraint templates applied"
          else
            echo "âš ï¸  No policies directory found (k8s/policies/)"
          fi
      
      - name: ğŸ”’ Apply Constraints
        if: github.event.inputs.action != 'uninstall' && github.event.inputs.apply_policies == 'true'
        run: |
          echo "ğŸ”’ Applying Constraints..."
          
          if [ -d "k8s/policies" ]; then
            # Apply constraints
            for constraint in k8s/policies/constraint-*.yaml; do
              # Skip constraint templates (already applied)
              if [[ "$constraint" != *"constraint-template"* ]]; then
                if [ -f "$constraint" ]; then
                  echo "  Applying $(basename $constraint)..."
                  kubectl apply -f "$constraint"
                fi
              fi
            done
            
            echo "âœ… Constraints applied"
          else
            echo "âš ï¸  No policies directory found"
          fi
      
      - name: ğŸ“Š Create ServiceMonitor for Prometheus
        if: github.event.inputs.action == 'install'
        run: |
          echo "ğŸ“Š Creating ServiceMonitor for Prometheus integration..."
          
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Service
          metadata:
            name: gatekeeper-controller-manager-metrics
            namespace: gatekeeper-system
            labels:
              app: gatekeeper
              release: kube-prometheus-stack
          spec:
            ports:
            - name: metrics
              port: 8888
              protocol: TCP
              targetPort: 8888
            selector:
              control-plane: controller-manager
              gatekeeper.sh/operation: webhook
          ---
          apiVersion: monitoring.coreos.com/v1
          kind: ServiceMonitor
          metadata:
            name: gatekeeper-controller-manager
            namespace: gatekeeper-system
            labels:
              app: gatekeeper
              release: kube-prometheus-stack
          spec:
            selector:
              matchLabels:
                app: gatekeeper
            namespaceSelector:
              matchNames:
              - gatekeeper-system
            endpoints:
            - port: metrics
              interval: 30s
              path: /metrics
          EOF
          
          echo "âœ… ServiceMonitor created for Prometheus"
      
      - name: ğŸ“Š Gatekeeper Status
        if: github.event.inputs.action != 'uninstall'
        run: |
          echo "ğŸ“Š Gatekeeper Status:"
          echo ""
          
          echo "ğŸ”¹ Pods:"
          kubectl get pods -n gatekeeper-system
          echo ""
          
          echo "ğŸ”¹ Constraint Templates:"
          kubectl get constrainttemplates
          echo ""
          
          echo "ğŸ”¹ Constraints:"
          kubectl get constraints --all-namespaces
          echo ""
          
          echo "ğŸ”¹ Services:"
          kubectl get svc -n gatekeeper-system
          echo ""
      
      - name: ğŸ—‘ï¸ Uninstall Gatekeeper
        if: github.event.inputs.action == 'uninstall'
        run: |
          echo "ğŸ—‘ï¸ Uninstalling OPA Gatekeeper..."
          echo ""
          
          # Delete all constraints
          echo "Deleting constraints..."
          kubectl delete constraints --all --all-namespaces || true
          
          # Delete all constraint templates
          echo "Deleting constraint templates..."
          kubectl delete constrainttemplates --all || true
          
          # Uninstall Helm release
          echo "Uninstalling Helm release..."
          helm uninstall gatekeeper -n gatekeeper-system || true
          
          # Delete namespace
          echo "Deleting namespace..."
          kubectl delete namespace gatekeeper-system || true
          
          echo "âœ… Gatekeeper uninstalled"
      
      - name: ğŸ“ Summary
        if: always()
        run: |
          echo "## ğŸ›¡ï¸ OPA Gatekeeper Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** ${{ env.AKS_CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** ${{ env.AZURE_RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.action }}" != "uninstall" ]; then
            echo "### ğŸ“Š Status" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl get pods -n gatekeeper-system >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No pods found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ğŸ“œ Policies" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl get constrainttemplates >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No templates" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ğŸ”’ Constraints" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl get constraints --all-namespaces >> $GITHUB_STEP_SUMMARY 2>&1 || echo "No constraints" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Uninstall Complete" >> $GITHUB_STEP_SUMMARY
            echo "OPA Gatekeeper has been removed from the cluster." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“– **Documentation:** [k8s/policies/README.md](k8s/policies/README.md)" >> $GITHUB_STEP_SUMMARY
